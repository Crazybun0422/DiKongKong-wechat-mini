<view class="page">
  <view class="map-wrap">
    <map
      id="main-map"
      class="map-canvas"
      longitude="{{center.longitude}}"
      latitude="{{center.latitude}}"
      scale="{{scale}}"
      min-scale="{{minScale}}"
      max-scale="{{maxScale}}"
      subkey="{{mapSubKey}}"
      layer-style="1"
      show-location="true"
      markers="{{markers}}"
      polygons="{{polygons}}"
      circles="{{circles}}"
      bindregionchange="onRegionChange"
      bindupdated="onMapUpdated"
      bindmarkertap="onMarkerTap"
      bindcallouttap="onMarkerCalloutTap"
    />
    <image class="center-pin" src="/assets/position.png" mode="widthFix" />

    <view class="preflight-overlay" wx:if="{{showDashboardPanel}}">
      <view class="preflight-card">
        <view class="preflight-title">飞前安全准备</view>
        <view class="drone-picker-block">
          <!-- <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view> -->
          <view class="drone-picker-display" bindtap="openDronePicker">
            <text class="preflight-label">机型：</text>
            <text class="drone-picker-value picker-underline">{{selectedDroneName}}</text>
          </view>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于 UOM 划分：</text>
          <text class="preflight-value {{'tone-' + uomTone}}">{{uomStatus}}</text>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于大疆划分：</text>
          <text class="preflight-value {{'tone-' + djiTone}}">{{djiStatus}}</text>
        </view>
        <view class="preflight-row temporary-no-fly-row">
          <text class="preflight-label">临时禁飞：</text>
          <block wx:if="{{temporaryNoFlyZoneInfo}}">
            <view class="temporary-no-fly-content">
              <image class="temporary-no-fly-icon" src="/assets/alarm.png" mode="widthFix" />
              <view
                wx:if="{{temporaryNoFlyZoneInfo.hasLink}}"
                class="temporary-no-fly-link"
                hover-class="temporary-no-fly-link-hover"
                bindtap="onTemporaryZoneLinkTap"
                data-link="{{temporaryNoFlyZoneInfo.link}}"
                data-path="{{temporaryNoFlyZoneInfo.linkPath}}"
              >
                {{temporaryNoFlyZoneInfo.displayName}}
              </view>
              <text wx:else class="temporary-no-fly-name">{{temporaryNoFlyZoneInfo.displayName}}</text>
            </view>
          </block>
          <text class="preflight-value {{'tone-' + temporaryNoFlyTone}}" wx:else>{{temporaryNoFlyText}}</text>
        </view>
        <text class="preflight-extra" wx:if="{{djiStatusExtra}}">{{djiStatusExtra}}</text>

        <view class="control-row">
          <view class="locate-wrapper">
            <button class="locate-circle"
        hover-class="locate-hover"
        hover-start-time="10"
        hover-stay-time="60"
        bindtap="onLocateTap">
  <image class="locate-icon" src="/assets/location.png" mode="widthFix" />
</button>
          </view>
          <view class="search-stack">
            <view class="search-pill">
              <input
                class="search-field"
                type="text"
                placeholder="搜索"
                placeholder-style="color:#f1f1f1"
                value="{{keyword}}"
                bindinput="onKeywordInput"
                confirm-type="search"
                bindconfirm="onSearchConfirm"
              />
              <button
                class="search-btn"
                hover-class="search-btn-hover"
                hover-start-time="10"
                hover-stay-time="80"
                bindtap="onSearchTap"
              >
                <image class="search-btn-icon" src="/assets/search.png" mode="aspectFit" />
              </button>
            </view>
            <view class="search-suggest-panel" wx:if="{{searchSuggestions.length || searchSuggestLoading || searchSuggestError}}">
              <view class="search-suggest-state" wx:if="{{searchSuggestLoading}}">搜索中...</view>
              <view class="search-suggest-state" wx:elif="{{searchSuggestError}}">{{searchSuggestError}}</view>
              <scroll-view scroll-y="true" class="search-suggest-scroll" wx:else>
                <block wx:for="{{searchSuggestions}}" wx:key="id">
                  <view
                    class="search-suggest-item"
                    data-index="{{index}}"
                    bindtap="onSuggestionTap"
                  >
                    <text class="suggest-title">{{item.title}}</text>
                    <text class="suggest-address" wx:if="{{item.address}}">{{item.address}}</text>
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="floating-controls" wx:if="{{activeTab === 'home'}}">
      <button
        class="dashboard-toggle {{showDashboardPanel ? 'is-active' : ''}}"
        hover-class="dashboard-toggle-hover"
        bindtap="toggleDashboardPanel"
      >
        <image class="dashboard-toggle-icon" src="/assets/dashboard.png" mode="aspectFit" />
      </button>
      <button
        class="marker-button"
        hover-class="marker-button-hover"
        bindtap="onMarkerButtonTap"
      >
        <image class="marker-button-icon" src="/assets/target.png" mode="aspectFit" />
      </button>
    </view>

    <view class="bottom-controls">
      <view class="bottom-menu">
        <button class="menu-btn {{activeTab === 'home' ? 'is-active' : ''}}" bindtap="onMenuHomeTap">
          <image class="menu-icon" src="/assets/home.png" mode="aspectFit" />
        </button>
        <button class="menu-btn {{activeTab === 'profile' ? 'is-active' : ''}}" bindtap="onMenuProfileTap">
          <image class="menu-icon" src="/assets/profile.png" mode="aspectFit" />
        </button>
      </view>

      <button
        class="chat-fab"
        hover-class="chat-fab-hover"
        bindtap="onChatButtonTap"
      >
        <image class="chat-fab-icon" src="/assets/ai-chat.png" mode="aspectFit" />
      </button>
    </view>
    <block wx:if="{{dronePickerVisible}}">
      <view class="drone-picker-mask" bindtap="closeDronePicker"></view>
      <view class="drone-picker-sheet">
        <view class="drone-picker-sheet-header">
          <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view>
          <text class="drone-picker-confirm" bindtap="confirmDronePicker">确定</text>
        </view>
        <scroll-view class="drone-picker-sheet-list" scroll-y="true">
          <block wx:for="{{droneNames}}" wx:key="index">
            <view
              class="drone-picker-option {{pendingDroneIndex === index ? 'is-active' : ''}}"
              data-index="{{index}}"
              bindtap="onSelectDroneOption"
            >
              {{item}}
            </view>
          </block>
        </scroll-view>
      </view>
    </block>

    <block wx:if="{{showPermissionChecklistPanel}}">
      <view class="permission-mask"></view>
      <view class="permission-panel">
        <view class="permission-title">开启飞行服务所需权限</view>
        <view class="permission-subtitle">以便我们提供精准空域预警与定位服务</view>
        <view class="permission-list">
          <view class="permission-item">
            <view class="permission-bullet"></view>
            <text class="permission-text">地理位置权限：帮助匹配附近空域政策与飞行保障服务</text>
          </view>
        </view>
        <view class="permission-actions">
          <button
            class="permission-button permission-button--ghost"
            hover-class="permission-button--ghost-hover"
            bindtap="onPermissionChecklistCancel"
            disabled="{{permissionChecklistLoading}}"
          >
            稍后再说
          </button>
          <button
            class="permission-button permission-button--solid"
            hover-class="permission-button--solid-hover"
            bindtap="onPermissionChecklistConfirm"
            loading="{{permissionChecklistLoading}}"
            disabled="{{permissionChecklistLoading}}"
          >
            立即开启
          </button>
        </view>
        <view class="permission-footnote">授权后可随时在设置中调整权限</view>
      </view>
    </block>

    <!-- 头像昵称填写 -->
    <block wx:if="{{showProfileFill}}">
      <view class="permission-mask"></view>
      <view class="permission-panel">
        <view class="permission-title">完善头像与昵称</view>
        <view class="permission-subtitle">用于个性化飞行档案与头像展示</view>

        <form bindsubmit="onProfileFillSubmit">
          <view class="profile-fill-row">
            <view class="profile-avatar-slot">
              <button
                class="profile-avatar-button"
                open-type="chooseAvatar"
                bindchooseavatar="onChooseAvatar">
                <image
                  class="profile-avatar-image"
                  src="{{tempAvatarUrl || '/assets/default-avatar.png'}}"
                  mode="aspectFill" />
              </button>
            </view>
            <input
              class="profile-nickname-input"
              type="nickname"
              name="nickname"
              placeholder="填写/选择微信昵称"
              bindinput="onNicknameInput"
              value="{{tempNickname}}" />
          </view>
          <text class="profile-avatar-tip">点击上传</text>

          <view class="permission-actions">
            <button class="permission-button permission-button--ghost" bindtap="onProfileFillCancel">取消</button>
            <button class="permission-button permission-button--solid" form-type="submit">保存</button>
          </view>
          <view class="permission-footnote">头像昵称仅用于展示，可随时在设置中修改</view>
        </form>
      </view>
    </block>

    <block wx:if="{{markerDetailVisible}}">
      <view class="marker-detail-mask {{markerDetailClosing ? 'marker-detail-mask--closing' : ''}}" bindtap="onMarkerDetailMaskTap"></view>
      <view
        class="marker-detail-sheet {{markerDetailClosing ? 'is-closing' : ''}} {{markerDetailExpanding ? 'is-expanding' : ''}}"
        catchtouchstart="onMarkerDetailTouchStart"
        catchtouchmove="onMarkerDetailTouchMove"
        catchtouchend="onMarkerDetailTouchEnd"
        catchtouchcancel="onMarkerDetailTouchCancel"
      >
        <view class="marker-detail-handle"></view>
        <view class="marker-detail-header">
          <view class="marker-detail-info">
            <text class="marker-detail-name">{{markerDetail.name || '未命名商户'}}</text>
            <text
              class="marker-detail-location"
              wx:if="{{markerDetail.locationText}}"
            >
              {{markerDetail.locationText}}
            </text>
          </view>
        </view>
        <view class="marker-detail-body">
          <view class="marker-detail-cover" wx:if="{{markerDetail.images && markerDetail.images.length}}">
            <image class="marker-detail-cover-image" src="{{markerDetail.images[0].url}}" mode="aspectFill" />
          </view>
          <view class="marker-detail-cover marker-detail-cover--placeholder" wx:else>
            <text class="marker-detail-cover-text">暂无商户图片</text>
          </view>
        </view>
        <view class="marker-detail-gesture-hint">
          <text class="marker-detail-gesture-text">上滑查看详情</text>
        </view>
      </view>
    </block>

    <block wx:if="{{markerPageVisible}}">
      <view class="marker-page {{markerPageClosing ? 'marker-page--closing' : 'marker-page--open'}}">
        <view class="marker-page-mask" bindtap="onMarkerPageMaskTap"></view>
        <scroll-view
          scroll-y
          class="marker-page-scroll"
          bindscroll="onMarkerPageScroll"
          bindtouchstart="onMarkerPageTouchStart"
          bindtouchmove="onMarkerPageTouchMove"
          bindtouchend="onMarkerPageTouchEnd"
          bindtouchcancel="onMarkerPageTouchCancel"
        >
          <view class="marker-page-hero">
            <block wx:if="{{markerPageDetail.images && markerPageDetail.images.length}}">
              <swiper
                class="marker-page-swiper"
                autoplay="{{false}}"
                circular="{{true}}"
                bindchange="onMarkerPageSwiperChange"
                current="{{markerPageCurrentImage}}"
              >
                <block wx:for="{{markerPageDetail.images}}" wx:key="id">
                  <swiper-item>
                    <image class="marker-page-swiper-image" src="{{item.url}}" mode="aspectFill" />
                  </swiper-item>
                </block>
              </swiper>
              <view class="marker-page-swiper-dots" wx:if="{{markerPageDetail.images.length}}">
                <block wx:for="{{markerPageDetail.images}}" wx:key="id">
                  <view class="marker-page-swiper-dot {{index === markerPageCurrentImage ? 'is-active' : ''}}"></view>
                </block>
              </view>
            </block>
            <view class="marker-page-hero-placeholder" wx:else>
              <text class="marker-page-hero-placeholder-text">暂无商户图片</text>
            </view>
          </view>

          <view class="marker-page-body">
            <view class="marker-page-header">
              <text class="marker-page-title">{{markerPageDetail.name || '未命名商户'}}</text>
            </view>

            <view
              class="marker-page-honors"
              wx:if="{{markerPageDetail.honors && markerPageDetail.honors.length}}"
            >
              <block wx:for="{{markerPageDetail.honors}}" wx:key="*this">
                <view class="marker-page-honor-chip">{{item}}</view>
              </block>
            </view>

            <view
              class="marker-page-address"
              wx:if="{{markerPageDetail.locationText || markerPageDetail.phone}}"
            >
              <view class="marker-page-address-info" wx:if="{{markerPageDetail.locationText}}">
                <text class="marker-page-address-label">地址</text>
                <text class="marker-page-address-text">{{markerPageDetail.locationText}}</text>
              </view>
              <view class="marker-page-address-actions">
                <view
                  class="marker-page-action"
                  wx:if="{{markerPageDetail.phone}}"
                  data-phone="{{markerPageDetail.phone}}"
                  data-marker-id="{{markerPageDetail.markerId || markerPageDetail.id || ''}}"
                  data-name="{{markerPageDetail.name || ''}}"
                  bindtap="onMarkerPageCallTap"
                >
                  <view class="marker-page-action-icon">
                    <image class="marker-page-action-image" src="/assets/m-telephone.png" mode="aspectFit" />
                  </view>
                  <text class="marker-page-action-label">电话</text>
                </view>
                <view
                  class="marker-page-action"
                  wx:if="{{markerPageDetail.latitude && markerPageDetail.longitude}}"
                  data-latitude="{{markerPageDetail.latitude}}"
                  data-longitude="{{markerPageDetail.longitude}}"
                  data-name="{{markerPageDetail.name || '商户位置'}}"
                  data-address="{{markerPageDetail.locationText || ''}}"
                  bindtap="onMarkerPageNavigateTap"
                >
                  <view class="marker-page-action-icon">
                    <image class="marker-page-action-image" src="/assets/m-target.png" mode="aspectFit" />
                  </view>
                  <text class="marker-page-action-label">位置</text>
                </view>
              </view>
            </view>

            <view class="marker-page-section">
              <text class="marker-page-section-title">简介</text>
              <text class="marker-page-section-text" wx:if="{{markerPageDetail.description}}">
                {{markerPageDetail.description}}
              </text>
              <text class="marker-page-section-text marker-page-section-text--placeholder" wx:else>
                暂无简介
              </text>
            </view>

            <view
              class="marker-page-section"
              wx:if="{{markerPageDetail.attachments && markerPageDetail.attachments.length}}"
            >
              <text class="marker-page-section-title">附件</text>
              <view class="marker-page-link-list">
                <block wx:for="{{markerPageDetail.attachments}}" wx:key="id">
                  <view
                    class="marker-page-link-item"
                    data-url="{{item.url}}"
                    bindtap="onMarkerPageAttachmentTap"
                  >
                    <view class="marker-page-link-info">
                      <text class="marker-page-link-text">{{item.shortName || item.displayName || item.fileName || '附件'}}</text>
                    </view>
                    <image class="marker-page-link-icon" src="/assets/f-download.png" mode="aspectFit" />
                  </view>
                </block>
              </view>
            </view>

            <block wx:if="{{markerPageDetail.videoAccounts && markerPageDetail.videoAccounts.length}}">
              <block wx:for="{{markerPageDetail.videoAccounts}}" wx:key="id">
                <view
                  class="marker-page-link-item marker-page-link-item--video"
                  data-url="{{item.url || ''}}"
                  data-finder="{{item.finderUserName || ''}}"
                  data-activity="{{item.activityId || ''}}"
                  bindtap="onMarkerPageVideoTap"
                >
                  <view class="marker-page-link-info">
                    <text class="marker-page-link-text">{{markerPageDetail.videoAccounts.length > 1 ? ('视频号内容 ' + (index + 1)) : '丰富的视频案例介绍'}}</text>
                    <text class="marker-page-link-arrow">></text>
                  </view>
                  <image class="marker-page-link-icon" src="/assets/v-account.png" mode="aspectFit" />
                </view>
              </block>
            </block>

            <view
              class="marker-page-qrcode-wrapper"
              wx:if="{{markerPageDetail.qrCodes && markerPageDetail.qrCodes.length}}"
            >
              <image class="marker-page-qrcode" src="{{markerPageDetail.qrCodes[0].url}}" mode="aspectFit" />
            </view>
          </view>
        </scroll-view>

        <button open-type="share" class="marker-page-share">
          <image class="marker-page-share-icon" src="/assets/tansmit.png" mode="aspectFit" />
          <text class="marker-page-share-text">转发</text>
        </button>
        <view class="marker-page-close-hint">下滑关闭详情</view>
      </view>
    </block>

    <block wx:if="{{callSheetVisible}}">
      <view class="call-sheet-mask" bindtap="onCallSheetMaskTap"></view>
      <view class="call-sheet">
        <view class="call-sheet-message">来电时，请说明通过“低空星球”看到我的</view>
        <button class="call-sheet-button call-sheet-button--primary" bindtap="onCallSheetConfirm">
          {{callSheetPhone}}
        </button>
        <button class="call-sheet-button call-sheet-button--secondary" bindtap="onCallSheetCancel">取消</button>
      </view>
    </block>

  </view>
</view>
