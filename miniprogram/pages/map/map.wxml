<view class="page">
  <view class="map-wrap">
    <map
      id="main-map"
      class="map-canvas"
      longitude="{{center.longitude}}"
      latitude="{{center.latitude}}"
      scale="{{scale}}"
      min-scale="{{minScale}}"
      max-scale="{{maxScale}}"
      show-location="true"
      markers="{{markers}}"
      polygons="{{polygons}}"
      circles="{{circles}}"
      bindregionchange="onRegionChange"
      bindupdated="onMapUpdated"
    />
    <view class="center-pin"></view>

    <view class="preflight-overlay" wx:if="{{showDashboardPanel}}">
      <view class="preflight-card">
        <view class="preflight-title">飞前安全准备</view>
        <view class="drone-picker-block">
          <!-- <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view> -->
          <view class="drone-picker-display" bindtap="openDronePicker">
            <text class="preflight-label">机型：</text>
            <text class="drone-picker-value picker-underline">{{selectedDroneName}}</text>
          </view>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于 UOM 划分：</text>
          <text class="preflight-value {{'tone-' + uomTone}}">{{uomStatus}}</text>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于大疆划分：</text>
          <text class="preflight-value {{'tone-' + djiTone}}">{{djiStatus}}</text>
        </view>
        <text class="preflight-extra" wx:if="{{djiStatusExtra}}">{{djiStatusExtra}}</text>

        <view class="control-row">
          <view class="locate-wrapper">
            <button class="locate-circle"
        hover-class="locate-hover"
        hover-start-time="10"
        hover-stay-time="60"
        bindtap="onLocateTap">
  <image class="locate-icon" src="/assets/location.png" mode="widthFix" />
</button>
          </view>
          <view class="search-stack">
            <view class="search-pill">
              <input
                class="search-field"
                type="text"
                placeholder="搜索"
                placeholder-style="color:#f1f1f1"
                value="{{keyword}}"
                bindinput="onKeywordInput"
                confirm-type="search"
                bindconfirm="onSearchConfirm"
              />
              <button
                class="search-btn"
                hover-class="search-btn-hover"
                hover-start-time="10"
                hover-stay-time="80"
                bindtap="onSearchTap"
              >
                <image class="search-btn-icon" src="/assets/search.png" mode="aspectFit" />
              </button>
            </view>
            <view class="search-suggest-panel" wx:if="{{searchSuggestions.length || searchSuggestLoading || searchSuggestError}}">
              <view class="search-suggest-state" wx:if="{{searchSuggestLoading}}">搜索中...</view>
              <view class="search-suggest-state" wx:elif="{{searchSuggestError}}">{{searchSuggestError}}</view>
              <scroll-view scroll-y="true" class="search-suggest-scroll" wx:else>
                <block wx:for="{{searchSuggestions}}" wx:key="id">
                  <view
                    class="search-suggest-item"
                    data-index="{{index}}"
                    bindtap="onSuggestionTap"
                  >
                    <text class="suggest-title">{{item.title}}</text>
                    <text class="suggest-address" wx:if="{{item.address}}">{{item.address}}</text>
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="floating-controls">
      <button
        class="dashboard-toggle {{showDashboardPanel ? 'is-active' : ''}}"
        hover-class="dashboard-toggle-hover"
        bindtap="toggleDashboardPanel"
      >
        <image class="dashboard-toggle-icon" src="/assets/dashboard.png" mode="aspectFit" />
      </button>
      <button
        class="marker-button"
        hover-class="marker-button-hover"
        bindtap="onMarkerButtonTap"
      >
        <image class="marker-button-icon" src="/assets/target.png" mode="aspectFit" />
      </button>
    </view>

    <view class="bottom-controls">
      <view class="bottom-menu">
        <button class="menu-btn {{activeTab === 'home' ? 'is-active' : ''}}" bindtap="onMenuHomeTap">
          <image class="menu-icon" src="/assets/home.png" mode="aspectFit" />
        </button>
        <button class="menu-btn {{activeTab === 'profile' ? 'is-active' : ''}}" bindtap="onMenuProfileTap">
          <image class="menu-icon" src="/assets/profile.png" mode="aspectFit" />
        </button>
      </view>

      <button
        class="chat-fab"
        hover-class="chat-fab-hover"
        bindtap="onChatButtonTap"
      >
        <image class="chat-fab-icon" src="/assets/ai-chat.png" mode="aspectFit" />
      </button>
    </view>
    <block wx:if="{{dronePickerVisible}}">
      <view class="drone-picker-mask" bindtap="closeDronePicker"></view>
      <view class="drone-picker-sheet">
        <view class="drone-picker-sheet-header">
          <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view>
          <text class="drone-picker-confirm" bindtap="confirmDronePicker">确定</text>
        </view>
        <scroll-view class="drone-picker-sheet-list" scroll-y="true">
          <block wx:for="{{droneNames}}" wx:key="index">
            <view
              class="drone-picker-option {{pendingDroneIndex === index ? 'is-active' : ''}}"
              data-index="{{index}}"
              bindtap="onSelectDroneOption"
            >
              {{item}}
            </view>
          </block>
        </scroll-view>
      </view>
    </block>
  </view>
</view>
