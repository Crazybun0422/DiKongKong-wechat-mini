<view class="page">
  <view class="map-wrap">
    <map
      id="main-map"
      class="map-canvas"
      longitude="{{center.longitude}}"
      latitude="{{center.latitude}}"
      scale="{{scale}}"
      min-scale="{{minScale}}"
      max-scale="{{maxScale}}"
      subkey="{{mapSubKey}}"
      layer-style="1"
      show-location="true"
      markers="{{markers}}"
      polygons="{{polygons}}"
      circles="{{circles}}"
      bindregionchange="onRegionChange"
      bindupdated="onMapUpdated"
      bindmarkertap="onMarkerTap"
      bindcallouttap="onMarkerCalloutTap"
    />
    <image class="center-pin" src="/assets/position.png" mode="widthFix" />

    <view class="preflight-overlay" wx:if="{{showDashboardPanel}}">
      <view class="preflight-card">
        <view class="preflight-title">飞前安全准备</view>
        <view class="drone-picker-block">
          <!-- <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view> -->
          <view class="drone-picker-display" bindtap="openDronePicker">
            <text class="preflight-label">机型：</text>
            <text class="drone-picker-value picker-underline">{{selectedDroneName}}</text>
          </view>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于 UOM 划分：</text>
          <text class="preflight-value {{'tone-' + uomTone}}">{{uomStatus}}</text>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于大疆划分：</text>
          <text class="preflight-value {{'tone-' + djiTone}}">{{djiStatus}}</text>
        </view>
        <view class="preflight-row temporary-no-fly-row">
          <text class="preflight-label">临时禁飞：</text>
          <block wx:if="{{temporaryNoFlyZoneInfo}}">
            <view class="temporary-no-fly-content">
              <image class="temporary-no-fly-icon" src="/assets/alarm.png" mode="widthFix" />
              <view
                wx:if="{{temporaryNoFlyZoneInfo.hasLink}}"
                class="temporary-no-fly-link"
                hover-class="temporary-no-fly-link-hover"
                bindtap="onTemporaryZoneLinkTap"
                data-link="{{temporaryNoFlyZoneInfo.link}}"
                data-path="{{temporaryNoFlyZoneInfo.linkPath}}"
              >
                {{temporaryNoFlyZoneInfo.displayName}}
              </view>
              <text wx:else class="temporary-no-fly-name">{{temporaryNoFlyZoneInfo.displayName}}</text>
            </view>
          </block>
          <text class="preflight-value {{'tone-' + temporaryNoFlyTone}}" wx:else>{{temporaryNoFlyText}}</text>
        </view>
        <text class="preflight-extra" wx:if="{{djiStatusExtra}}">{{djiStatusExtra}}</text>

        <view class="control-row">
          <view class="locate-wrapper">
            <button class="locate-circle"
        hover-class="locate-hover"
        hover-start-time="10"
        hover-stay-time="60"
        bindtap="onLocateTap">
  <image class="locate-icon" src="/assets/location.png" mode="widthFix" />
</button>
          </view>
          <view class="search-stack">
            <view class="search-pill">
              <input
                class="search-field"
                type="text"
                placeholder="搜索"
                placeholder-style="color:#f1f1f1"
                value="{{keyword}}"
                bindinput="onKeywordInput"
                confirm-type="search"
                bindconfirm="onSearchConfirm"
              />
              <button
                class="search-btn"
                hover-class="search-btn-hover"
                hover-start-time="10"
                hover-stay-time="80"
                bindtap="onSearchTap"
              >
                <image class="search-btn-icon" src="/assets/search.png" mode="aspectFit" />
              </button>
            </view>
            <view class="search-suggest-panel" wx:if="{{searchSuggestions.length || searchSuggestLoading || searchSuggestError}}">
              <view class="search-suggest-state" wx:if="{{searchSuggestLoading}}">搜索中...</view>
              <view class="search-suggest-state" wx:elif="{{searchSuggestError}}">{{searchSuggestError}}</view>
              <scroll-view scroll-y="true" class="search-suggest-scroll" wx:else>
                <block wx:for="{{searchSuggestions}}" wx:key="id">
                  <view
                    class="search-suggest-item"
                    data-index="{{index}}"
                    bindtap="onSuggestionTap"
                  >
                    <text class="suggest-title">{{item.title}}</text>
                    <text class="suggest-address" wx:if="{{item.address}}">{{item.address}}</text>
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="floating-controls" wx:if="{{activeTab === 'home'}}">
      <button
        class="dashboard-toggle {{showDashboardPanel ? 'is-active' : ''}}"
        hover-class="dashboard-toggle-hover"
        bindtap="toggleDashboardPanel"
      >
        <image class="dashboard-toggle-icon" src="/assets/dashboard.png" mode="aspectFit" />
      </button>
      <button
        class="marker-button"
        hover-class="marker-button-hover"
        bindtap="onMarkerButtonTap"
      >
        <image class="marker-button-icon" src="/assets/target.png" mode="aspectFit" />
      </button>
    </view>

    <view class="bottom-controls">
      <view class="bottom-menu">
        <button class="menu-btn {{activeTab === 'home' ? 'is-active' : ''}}" bindtap="onMenuHomeTap">
          <image class="menu-icon" src="/assets/home.png" mode="aspectFit" />
        </button>
        <button class="menu-btn {{activeTab === 'profile' ? 'is-active' : ''}}" bindtap="onMenuProfileTap">
          <image class="menu-icon" src="/assets/profile.png" mode="aspectFit" />
        </button>
      </view>

      <button
        class="chat-fab"
        hover-class="chat-fab-hover"
        bindtap="onChatButtonTap"
      >
        <image class="chat-fab-icon" src="/assets/ai-chat.png" mode="aspectFit" />
      </button>
    </view>
    <block wx:if="{{dronePickerVisible}}">
      <view class="drone-picker-mask" bindtap="closeDronePicker"></view>
      <view class="drone-picker-sheet">
        <view class="drone-picker-sheet-header">
          <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view>
          <text class="drone-picker-confirm" bindtap="confirmDronePicker">确定</text>
        </view>
        <scroll-view class="drone-picker-sheet-list" scroll-y="true">
          <block wx:for="{{droneNames}}" wx:key="index">
            <view
              class="drone-picker-option {{pendingDroneIndex === index ? 'is-active' : ''}}"
              data-index="{{index}}"
              bindtap="onSelectDroneOption"
            >
              {{item}}
            </view>
          </block>
        </scroll-view>
      </view>
    </block>

    <block wx:if="{{showPermissionChecklistPanel}}">
      <view class="permission-mask"></view>
      <view class="permission-panel">
        <view class="permission-title">开启飞行服务所需权限</view>
        <view class="permission-subtitle">以便我们提供精准空域预警与定位服务</view>
        <view class="permission-list">
          <view class="permission-item">
            <view class="permission-bullet"></view>
            <text class="permission-text">地理位置权限：帮助匹配附近空域政策与飞行保障服务</text>
          </view>
        </view>
        <view class="permission-actions">
          <button
            class="permission-button permission-button--ghost"
            hover-class="permission-button--ghost-hover"
            bindtap="onPermissionChecklistCancel"
            disabled="{{permissionChecklistLoading}}"
          >
            稍后再说
          </button>
          <button
            class="permission-button permission-button--solid"
            hover-class="permission-button--solid-hover"
            bindtap="onPermissionChecklistConfirm"
            loading="{{permissionChecklistLoading}}"
            disabled="{{permissionChecklistLoading}}"
          >
            立即开启
          </button>
        </view>
        <view class="permission-footnote">授权后可随时在设置中调整权限</view>
      </view>
    </block>

    <!-- 头像昵称填写 -->
    <block wx:if="{{showProfileFill}}">
      <view class="permission-mask"></view>
      <view class="permission-panel">
        <view class="permission-title">完善头像与昵称</view>
        <view class="permission-subtitle">用于个性化飞行档案与头像展示</view>

        <form bindsubmit="onProfileFillSubmit">
          <view class="profile-fill-row">
            <view class="profile-avatar-slot">
              <button
                class="profile-avatar-button"
                open-type="chooseAvatar"
                bindchooseavatar="onChooseAvatar">
                <image
                  class="profile-avatar-image"
                  src="{{tempAvatarUrl || '/assets/default-avatar.png'}}"
                  mode="aspectFill" />
              </button>
            </view>
            <input
              class="profile-nickname-input"
              type="nickname"
              name="nickname"
              placeholder="填写/选择微信昵称"
              bindinput="onNicknameInput"
              value="{{tempNickname}}" />
          </view>
          <text class="profile-avatar-tip">点击上传</text>

          <view class="permission-actions">
            <button class="permission-button permission-button--ghost" bindtap="onProfileFillCancel">取消</button>
            <button class="permission-button permission-button--solid" form-type="submit">保存</button>
          </view>
          <view class="permission-footnote">头像昵称仅用于展示，可随时在设置中修改</view>
        </form>
      </view>
    </block>

    <block wx:if="{{showMarkerDetail && activeMarkerDetail}}">
      <view class="marker-detail-mask" catchtap="closeMarkerDetail"></view>
      <view
        class="marker-detail-sheet"
        bindtouchstart="onMarkerDetailTouchStart"
        bindtouchmove="onMarkerDetailTouchMove"
        bindtouchend="onMarkerDetailTouchEnd"
      >

        <view class="marker-detail-header">
          <view class="marker-detail-info">
            <text class="marker-detail-name">{{activeMarkerDetail.name || '未命名标记'}}</text>
            <text class="marker-detail-location" wx:if="{{activeMarkerDetail.locationText}}">{{activeMarkerDetail.locationText}}</text>
          </view>
          <view class="marker-detail-close" bindtap="closeMarkerDetail">
            <image
              class="marker-detail-close-icon"
              src="/assets/marker-detail-close.png"
              mode="aspectFit"
              bindtap="closeMarkerDetail"
            />
          </view>
        </view>
        <view class="marker-detail-body">
          <image
            class="marker-detail-cover"
            src="{{activeMarkerDetail.imageUrl}}"
            mode="aspectFill"
            wx:if="{{activeMarkerDetail.imageUrl}}"
          />
          <view class="marker-detail-cover marker-detail-cover--placeholder" wx:else>
            <text class="marker-detail-cover-text">暂未上传图片</text>
          </view>
        </view>
      </view>
    </block>
  </view>
</view>
