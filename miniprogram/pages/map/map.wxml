<view class="page">
  <view class="map-wrap">
    <map
      id="main-map"
      class="map-canvas"
      longitude="{{center.longitude}}"
      latitude="{{center.latitude}}"
      scale="{{scale}}"
      min-scale="{{minScale}}"
      max-scale="{{maxScale}}"
      subkey="{{mapSubKey}}"
      layer-style="1"
      show-location="true"
      markers="{{markers}}"
      polygons="{{polygons}}"
      circles="{{circles}}"
      bindregionchange="onRegionChange"
      bindupdated="onMapUpdated"
      bindmarkertap="onMarkerTap"
    />
    <image class="center-pin" src="/assets/position.png" mode="widthFix" />

    <view class="preflight-overlay" wx:if="{{showDashboardPanel}}">
      <view class="preflight-card">
        <view class="preflight-title">飞前安全准备</view>
        <view class="drone-picker-block">
          <!-- <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view> -->
          <view class="drone-picker-display" bindtap="openDronePicker">
            <text class="preflight-label">机型：</text>
            <text class="drone-picker-value picker-underline">{{selectedDroneName}}</text>
          </view>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于 UOM 划分：</text>
          <text class="preflight-value {{'tone-' + uomTone}}">{{uomStatus}}</text>
        </view>
        <view class="preflight-row">
          <text class="preflight-label">位于大疆划分：</text>
          <text class="preflight-value {{'tone-' + djiTone}}">{{djiStatus}}</text>
        </view>
        <text class="preflight-extra" wx:if="{{djiStatusExtra}}">{{djiStatusExtra}}</text>

        <view class="control-row">
          <view class="locate-wrapper">
            <button class="locate-circle"
        hover-class="locate-hover"
        hover-start-time="10"
        hover-stay-time="60"
        bindtap="onLocateTap">
  <image class="locate-icon" src="/assets/location.png" mode="widthFix" />
</button>
          </view>
          <view class="search-stack">
            <view class="search-pill">
              <input
                class="search-field"
                type="text"
                placeholder="搜索"
                placeholder-style="color:#f1f1f1"
                value="{{keyword}}"
                bindinput="onKeywordInput"
                confirm-type="search"
                bindconfirm="onSearchConfirm"
              />
              <button
                class="search-btn"
                hover-class="search-btn-hover"
                hover-start-time="10"
                hover-stay-time="80"
                bindtap="onSearchTap"
              >
                <image class="search-btn-icon" src="/assets/search.png" mode="aspectFit" />
              </button>
            </view>
            <view class="search-suggest-panel" wx:if="{{searchSuggestions.length || searchSuggestLoading || searchSuggestError}}">
              <view class="search-suggest-state" wx:if="{{searchSuggestLoading}}">搜索中...</view>
              <view class="search-suggest-state" wx:elif="{{searchSuggestError}}">{{searchSuggestError}}</view>
              <scroll-view scroll-y="true" class="search-suggest-scroll" wx:else>
                <block wx:for="{{searchSuggestions}}" wx:key="id">
                  <view
                    class="search-suggest-item"
                    data-index="{{index}}"
                    bindtap="onSuggestionTap"
                  >
                    <text class="suggest-title">{{item.title}}</text>
                    <text class="suggest-address" wx:if="{{item.address}}">{{item.address}}</text>
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="floating-controls" wx:if="{{activeTab === 'home'}}">
      <button
        class="dashboard-toggle {{showDashboardPanel ? 'is-active' : ''}}"
        hover-class="dashboard-toggle-hover"
        bindtap="toggleDashboardPanel"
      >
        <image class="dashboard-toggle-icon" src="/assets/dashboard.png" mode="aspectFit" />
      </button>
      <button
        class="marker-button"
        hover-class="marker-button-hover"
        bindtap="onMarkerButtonTap"
      >
        <image class="marker-button-icon" src="/assets/target.png" mode="aspectFit" />
      </button>
    </view>

    <view class="bottom-controls">
      <view class="bottom-menu">
        <button class="menu-btn {{activeTab === 'home' ? 'is-active' : ''}}" bindtap="onMenuHomeTap">
          <image class="menu-icon" src="/assets/home.png" mode="aspectFit" />
        </button>
        <button class="menu-btn {{activeTab === 'profile' ? 'is-active' : ''}}" bindtap="onMenuProfileTap">
          <image class="menu-icon" src="/assets/profile.png" mode="aspectFit" />
        </button>
      </view>

      <button
        class="chat-fab"
        hover-class="chat-fab-hover"
        bindtap="onChatButtonTap"
      >
        <image class="chat-fab-icon" src="/assets/ai-chat.png" mode="aspectFit" />
      </button>
    </view>
    <block wx:if="{{showMarkerDetail}}">
      <view class="marker-detail-layer">
        <view class="marker-detail-mask" bindtap="onMarkerDetailMaskTap"></view>
        <view class="marker-detail-container" catchtouchmove="noop">
          <view class="marker-detail-card" catchtap="noop">
            <image class="marker-detail-cover" src="{{markerDetail.coverImage}}" mode="aspectFill" />
            <scroll-view scroll-y="true" class="marker-detail-scroll">
              <view class="marker-detail-body">
                <view class="marker-detail-header">
                  <view class="marker-detail-title-wrap">
                    <text class="marker-detail-name">{{markerDetail.name || '附近点位'}}</text>
                    <text class="marker-detail-subtitle" wx:if="{{markerDetail.subtitle}}">{{markerDetail.subtitle}}</text>
                    <text class="marker-detail-address" wx:if="{{markerDetail.address}}">{{markerDetail.address}}</text>
                  </view>
                  <view class="marker-detail-close" bindtap="onCloseMarkerDetail">×</view>
                </view>

                <view
                  class="marker-detail-stats"
                  wx:if="{{markerDetail.stats && (markerDetail.stats.exposure || markerDetail.stats.calls)}}"
                >
                  <view class="marker-detail-stat">
                    <text class="marker-detail-stat-number">{{markerDetail.stats.exposure || 0}}</text>
                    <text class="marker-detail-stat-label">总曝光</text>
                  </view>
                  <view class="marker-detail-stat">
                    <text class="marker-detail-stat-number">{{markerDetail.stats.calls || 0}}</text>
                    <text class="marker-detail-stat-label">电话咨询</text>
                  </view>
                </view>

                <view class="marker-detail-section">
                  <text class="marker-detail-section-title">简介</text>
                  <text class="marker-detail-section-text">{{markerDetail.description || '暂无简介'}}</text>
                </view>

                <view class="marker-detail-section" wx:if="{{markerDetail.services && markerDetail.services.length}}">
                  <text class="marker-detail-section-title">服务内容</text>
                  <view class="marker-detail-tags">
                    <block wx:for="{{markerDetail.services}}" wx:key="index">
                      <view class="marker-detail-tag">{{item}}</view>
                    </block>
                  </view>
                  <text class="marker-detail-section-text" wx:if="{{markerDetail.serviceDescription}}">{{markerDetail.serviceDescription}}</text>
                </view>

                <view class="marker-detail-section" wx:if="{{markerDetail.qrCodes && markerDetail.qrCodes.length}}">
                  <text class="marker-detail-section-title">二维码</text>
                  <view class="marker-detail-qrcode">
                    <image class="marker-detail-qrcode-image" src="{{markerDetail.qrCodes[0]}}" mode="aspectFit" />
                    <text class="marker-detail-qrcode-tip" wx:if="{{markerDetail.qrCodeDescription}}">{{markerDetail.qrCodeDescription}}</text>
                  </view>
                </view>

                <view
                  class="marker-detail-section"
                  wx:if="{{(markerDetail.adminInfo && (markerDetail.adminInfo.name || markerDetail.adminInfo.title)) || markerDetail.phone}}"
                >
                  <text class="marker-detail-section-title">联系信息</text>
                  <view class="marker-detail-contact-item" wx:if="{{markerDetail.adminInfo && (markerDetail.adminInfo.name || markerDetail.adminInfo.title)}}">
                    <text class="marker-detail-contact-label">联系人</text>
                    <view class="marker-detail-contact-value">
                      <text>{{markerDetail.adminInfo.name}}</text>
                      <text wx:if="{{markerDetail.adminInfo.title}}">· {{markerDetail.adminInfo.title}}</text>
                    </view>
                  </view>
                  <view class="marker-detail-contact-item" wx:if="{{markerDetail.phone}}">
                    <text class="marker-detail-contact-label">电话</text>
                    <text class="marker-detail-contact-value">{{markerDetail.phone}}</text>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>

          <view
            class="marker-detail-actions"
            catchtap="noop"
            wx:if="{{markerDetail.phone || (markerDetail.gallery && markerDetail.gallery.length) || ((markerDetail.services && markerDetail.services.length) || markerDetail.serviceDescription)}}"
          >
            <button
              class="marker-action-btn"
              hover-class="marker-action-btn--hover"
              bindtap="onMarkerPhoneTap"
              wx:if="{{markerDetail.phone}}"
            >
              <image class="marker-action-icon" src="/assets/telephone.png" mode="aspectFit" />
              <text class="marker-action-label">电话咨询</text>
            </button>
            <button
              class="marker-action-btn"
              hover-class="marker-action-btn--hover"
              bindtap="onMarkerGalleryTap"
              wx:if="{{markerDetail.gallery && markerDetail.gallery.length}}"
            >
              <image class="marker-action-icon" src="/assets/dialog.png" mode="aspectFit" />
              <text class="marker-action-label">查看图集</text>
            </button>
            <button
              class="marker-action-btn"
              hover-class="marker-action-btn--hover"
              bindtap="onMarkerServicesTap"
              wx:if="{{(markerDetail.services && markerDetail.services.length) || markerDetail.serviceDescription}}"
            >
              <image class="marker-action-icon" src="/assets/dashboard.png" mode="aspectFit" />
              <text class="marker-action-label">查看服务</text>
            </button>
          </view>

          <view
            class="marker-phone-sheet"
            wx:if="{{markerPhoneSheetVisible}}"
            catchtap="noop"
            catchtouchmove="noop"
          >
            <text class="marker-phone-title">电话咨询</text>
            <text class="marker-phone-number">{{markerDetail.phone}}</text>
            <view class="marker-phone-actions">
              <button
                class="marker-phone-button marker-phone-button--ghost"
                hover-class="marker-phone-button--ghost-hover"
                bindtap="closeMarkerPhoneSheet"
              >
                取消
              </button>
              <button
                class="marker-phone-button marker-phone-button--solid"
                hover-class="marker-phone-button--solid-hover"
                bindtap="confirmMarkerPhoneCall"
              >
                拨打
              </button>
            </view>
          </view>
        </view>
      </view>
    </block>
    <block wx:if="{{dronePickerVisible}}">
      <view class="drone-picker-mask" bindtap="closeDronePicker"></view>
      <view class="drone-picker-sheet">
        <view class="drone-picker-sheet-header">
          <view class="drone-description">
            <text class="drone-description-title">此次执飞的无人机型号</text>
            <text class="drone-description-subtitle">不同机型在飞行高度/区域、报备有差异。</text>
          </view>
          <text class="drone-picker-confirm" bindtap="confirmDronePicker">确定</text>
        </view>
        <scroll-view class="drone-picker-sheet-list" scroll-y="true">
          <block wx:for="{{droneNames}}" wx:key="index">
            <view
              class="drone-picker-option {{pendingDroneIndex === index ? 'is-active' : ''}}"
              data-index="{{index}}"
              bindtap="onSelectDroneOption"
            >
              {{item}}
            </view>
          </block>
        </scroll-view>
      </view>
    </block>

    <block wx:if="{{showPermissionChecklistPanel}}">
      <view class="permission-mask"></view>
      <view class="permission-panel">
        <view class="permission-title">开启飞行服务所需权限</view>
        <view class="permission-subtitle">以便我们提供精准空域预警与定位服务</view>
        <view class="permission-list">
          <view class="permission-item">
            <view class="permission-bullet"></view>
            <text class="permission-text">地理位置权限：帮助匹配附近空域政策与飞行保障服务</text>
          </view>
        </view>
        <view class="permission-actions">
          <button
            class="permission-button permission-button--ghost"
            hover-class="permission-button--ghost-hover"
            bindtap="onPermissionChecklistCancel"
            disabled="{{permissionChecklistLoading}}"
          >
            稍后再说
          </button>
          <button
            class="permission-button permission-button--solid"
            hover-class="permission-button--solid-hover"
            bindtap="onPermissionChecklistConfirm"
            loading="{{permissionChecklistLoading}}"
            disabled="{{permissionChecklistLoading}}"
          >
            立即开启
          </button>
        </view>
        <view class="permission-footnote">授权后可随时在设置中调整权限</view>
      </view>
    </block>

    <!-- 头像昵称填写 -->
    <block wx:if="{{showProfileFill}}">
      <view class="permission-mask"></view>
      <view class="permission-panel">
        <view class="permission-title">完善头像与昵称</view>
        <view class="permission-subtitle">用于个性化飞行档案与头像展示</view>

        <form bindsubmit="onProfileFillSubmit">
          <view class="profile-fill-row">
            <view class="profile-avatar-slot">
              <button
                class="profile-avatar-button"
                open-type="chooseAvatar"
                bindchooseavatar="onChooseAvatar">
                <image
                  class="profile-avatar-image"
                  src="{{tempAvatarUrl || '/assets/default-avatar.png'}}"
                  mode="aspectFill" />
              </button>
            </view>
            <input
              class="profile-nickname-input"
              type="nickname"
              name="nickname"
              placeholder="填写/选择微信昵称"
              bindinput="onNicknameInput"
              value="{{tempNickname}}" />
          </view>
          <text class="profile-avatar-tip">点击上传</text>

          <view class="permission-actions">
            <button class="permission-button permission-button--ghost" bindtap="onProfileFillCancel">取消</button>
            <button class="permission-button permission-button--solid" form-type="submit">保存</button>
          </view>
          <view class="permission-footnote">头像昵称仅用于展示，可随时在设置中修改</view>
        </form>
      </view>
    </block>
  </view>
</view>
