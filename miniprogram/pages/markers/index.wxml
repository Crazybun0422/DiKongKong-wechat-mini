<view class="markers-page">
  <scroll-view
    scroll-y
    class="markers-scroll"
    wx:if="{{!showCreate && !showDetail}}"
    refresher-enabled="{{true}}"
    refresher-triggered="{{listRefreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
  >
    <view class="page-header">
      <view class="title-area">
        <text class="page-title">æˆ‘çš„æ ‡è®°</text>
        <text class="page-subtitle">ç®¡ç†åœ°å›¾æ ‡è®°ç”³æŠ¥ä¸å®¡æ ¸è¿›åº¦</text>
      </view>
      <button class="create-btn" bindtap="onCreateTap">æ–°å»ºæ ‡è®°</button>
    </view>

    <view class="status-tabs">
      <block wx:for="{{statusTabs}}" wx:key="id">
        <view
          class="status-tab {{filterStatus === item.id ? 'is-active' : ''}}"
          data-status="{{item.id}}"
          bindtap="onStatusTabTap"
        >
          <text>{{item.label}}</text>
        </view>
      </block>
    </view>

    <block wx:if="{{loading && !hasLoaded}}">
      <view class="state-card">åŠ è½½ä¸­...</view>
    </block>
    <block wx:elif="{{error}}">
      <view class="state-card state-error">
        <text class="state-text">{{error}}</text>
        <button class="retry-btn" bindtap="onRetryTap">é‡æ–°åŠ è½½</button>
      </view>
    </block>
    <block wx:elif="{{!visibleMarkers.length}}">
      <view class="empty-card">
        <view class="empty-icon">ğŸ“</view>
        <text class="empty-title">æš‚æœªåˆ›å»ºæ ‡è®°</text>
        <text class="empty-desc">æäº¤ä¼ä¸šã€æ™¯ç‚¹æˆ–è®­ç»ƒåŸºåœ°èµ„æ–™åå³å¯åœ¨åœ°å›¾ä¸Šå±•ç¤ºã€‚</text>
        <button class="empty-action" bindtap="onCreateTap">ç«‹å³åˆ›å»º</button>
      </view>
    </block>
    <block wx:else>
      <view class="marker-list">
        <block wx:for="{{visibleMarkers}}" wx:key="id">
          <view class="marker-card" bindtap="onMarkerCardTap" data-id="{{item.id}}">
            <view class="card-header">
              <text class="marker-name">{{item.name || 'æœªå‘½åæ ‡è®°'}}</text>
              <view class="status-badge {{item.reviewTone}}">{{item.reviewStatusLabel}}</view>
            </view>
            <view class="card-meta">
              <text class="meta-label">ä½ç½®</text>
              <text class="meta-value">{{item.locationText || 'æœªå¡«å†™ä½ç½®'}}</text>
            </view>
            <view class="card-meta">
              <text class="meta-label">æäº¤æ—¶é—´</text>
              <text class="meta-value">{{item.createdAtDisplay}}</text>
            </view>
            <view class="card-footer">
              <text class="paid-label {{item.paid ? 'is-paid' : 'is-unpaid'}}">{{item.paidLabel}}</text>
              <text class="card-arrow">â€º</text>
            </view>
          </view>
        </block>
      </view>
    </block>
  </scroll-view>

  <view wx:if="{{showDetail}}" class="drawer-overlay">
    <view class="drawer">
      <view class="drawer-header">
        <text class="drawer-title">æ ‡è®°è¯¦æƒ…</text>
        <view class="drawer-close" bindtap="onCloseDetail">âœ•</view>
      </view>
      <scroll-view scroll-y class="drawer-body">
        <view class="detail-section">
          <text class="detail-title">åŸºç¡€ä¿¡æ¯</text>
          <view class="detail-item">
            <text class="detail-label">æ ‡è®°åç§°</text>
            <text class="detail-value">{{activeMarker.name}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å®¡æ ¸çŠ¶æ€</text>
            <text class="detail-value status-text {{activeMarker.reviewTone}}">{{activeMarker.reviewStatusLabel}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ”¯ä»˜çŠ¶æ€</text>
            <text class="detail-value">{{activeMarker.paidLabel}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ä½ç½®</text>
            <text class="detail-value">{{activeMarker.locationText || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">è”ç³»ç”µè¯</text>
            <text class="detail-value">{{activeMarker.phone || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ç®€ä»‹</text>
            <text class="detail-value">{{activeMarker.description || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">åˆ›å»ºæ—¶é—´</text>
            <text class="detail-value">{{activeMarker.createdAtDisplay}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ›´æ–°æ—¶é—´</text>
            <text class="detail-value">{{activeMarker.updatedAtDisplay}}</text>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.industryHonorTags && activeMarker.industryHonorTags.length}}">
          <text class="detail-title">è¡Œä¸šè£èª‰</text>
          <view class="tag-display">
            <block wx:for="{{activeMarker.industryHonorTags}}" wx:key="*this">
              <view class="tag-chip">{{item}}</view>
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.images && activeMarker.images.length}}">
          <text class="detail-title">å±•ç¤ºå›¾</text>
          <view class="media-preview-grid">
            <block wx:for="{{activeMarker.images}}" wx:key="id">
              <image class="media-preview" src="{{item.url}}" mode="aspectFill" />
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.businessLicense}}">
          <text class="detail-title">è¥ä¸šæ‰§ç…§</text>
          <image class="license-preview" src="{{activeMarker.businessLicense.url}}" mode="aspectFill" />
        </view>

        <view class="detail-section" wx:if="{{activeMarker.attachments && activeMarker.attachments.length}}">
          <text class="detail-title">é™„ä»¶</text>
          <view class="attachment-list">
            <block wx:for="{{activeMarker.attachments}}" wx:key="id">
              <view class="attachment-item">
                <text class="attachment-icon">ğŸ“</text>
                <text class="attachment-name">{{item.fileName}}</text>
              </view>
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.qrCodes && activeMarker.qrCodes.length}}">
          <text class="detail-title">äºŒç»´ç </text>
          <view class="media-preview-grid">
            <block wx:for="{{activeMarker.qrCodes}}" wx:key="id">
              <image class="media-preview" src="{{item.url}}" mode="aspectFill" />
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.videoChannelUrls && activeMarker.videoChannelUrls.length}}">
          <text class="detail-title">è§†é¢‘å·é“¾æ¥</text>
          <view class="detail-list">
            <block wx:for="{{activeMarker.videoChannelUrls}}" wx:key="*this">
              <text class="detail-link">{{item}}</text>
            </block>
          </view>
        </view>

        <view
          class="detail-section"
          wx:if="{{activeMarker.adminInfo &&(activeMarker.adminInfo.name || activeMarker.adminInfo.phone || activeMarker.adminInfo.title)}}"
        >
          <text class="detail-title">ç®¡ç†å‘˜è”ç³»</text>
          <view class="detail-item">
            <text class="detail-label">å§“å</text>
            <text class="detail-value">{{activeMarker.adminInfo.name || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">èŒä½</text>
            <text class="detail-value">{{activeMarker.adminInfo.title || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ç”µè¯</text>
            <text class="detail-value">{{activeMarker.adminInfo.phone || 'æœªå¡«å†™'}}</text>
          </view>
        </view>

        <button
          class="danger-btn"
          data-id="{{activeMarker.id}}"
          bindtap="onDeleteMarkerTap"
          loading="{{deletingId === activeMarker.id}}"
          disabled="{{deletingId === activeMarker.id}}"
        >
          åˆ é™¤æ ‡è®°
        </button>
      </scroll-view>
    </view>
  </view>

  <view wx:if="{{showCreate}}" class="drawer-overlay">
    <view class="drawer">
      <view class="drawer-header">
        <text class="drawer-title">åˆ›å»ºåœ°å›¾æ ‡è®°</text>
        <view class="drawer-close" bindtap="onCloseCreate">âœ•</view>
      </view>
      <scroll-view scroll-y class="drawer-body">
        <view class="step-indicator">
          <block wx:for="{{createSteps}}" wx:key="label">
            <view class="step-item-wrapper">
              <view
                class="step-item {{createStep === index ? 'is-current' : (createStep > index ? 'is-finished' : '')}}"
                data-step="{{index}}"
                bindtap="onStepIndicatorTap"
              >
                <view class="step-circle {{createStep === index ? 'is-active' : (createStep > index ? 'is-finished' : '')}}">
                  <text>{{index + 1}}</text>
                </view>
                <text class="step-label">{{item.label}}</text>
              </view>
              <view
                wx:if="{{index < createSteps.length - 1}}"
                class="step-connector {{createStep > index ? 'is-active' : ''}}"
              ></view>
            </view>
          </block>
        </view>

        <block wx:if="{{createStep === 0}}">
          <view class="form-section">
            <text class="section-title">åŸºç¡€ä¿¡æ¯</text>
            <view class="form-item">
              <view class="form-label">
                <text class="required-indicator">*</text>
                <text>æ ‡è®°åç§°</text>
              </view>
              <input
                class="form-input"
                placeholder="è¯·è¾“å…¥ä¼ä¸šæˆ–åœºåœ°åç§°"
                value="{{form.name}}"
                data-field="name"
                bindinput="onFormInput"
              />
            </view>
            <view class="form-item">
              <view class="form-label">
                <text class="required-indicator">*</text>
                <text>æ ‡è®°ä½ç½®</text>
              </view>
              <view class="location-box" bindtap="onChooseLocation">
                <text class="location-text">{{form.locationText || 'è¯·é€‰æ‹©ä½ç½®'}}</text>
                <text class="location-action">é€‰æ‹©</text>
              </view>
            </view>
            <view class="form-item">
              <view class="form-label">
                <text class="required-indicator">*</text>
                <text>è”ç³»ç”µè¯</text>
              </view>
              <input
                class="form-input"
                placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
                value="{{form.phone}}"
                data-field="phone"
                bindinput="onFormInput"
              />
            </view>
            <view class="form-item">
              <view class="form-label">
                <text class="required-indicator">*</text>
                <text>æ ‡è®°ç®€ä»‹</text>
              </view>
              <textarea
                class="form-textarea"
                placeholder="è¯·è¾“å…¥ç»è¥äº®ç‚¹ã€æœåŠ¡å†…å®¹ç­‰ä¿¡æ¯"
                value="{{form.description}}"
                data-field="description"
                bindinput="onFormInput"
                maxlength="500"
                auto-height
              />
            </view>
            <view class="form-item">
              <text class="form-label">è¡Œä¸šè£èª‰</text>
              <view class="tag-editor">
                <block wx:for="{{form.industryHonorTags}}" wx:key="*this">
                  <view class="tag-chip">
                    <text>{{item}}</text>
                    <view class="tag-remove" data-index="{{index}}" bindtap="onRemoveTag">âœ•</view>
                  </view>
                </block>
                <input
                  class="tag-input"
                  placeholder="è¾“å…¥åå›è½¦æ·»åŠ "
                  value="{{tagInput}}"
                  confirm-type="done"
                  bindinput="onTagInput"
                  bindconfirm="onTagConfirm"
                />
              </view>
            </view>
            <view class="form-item">
              <text class="form-label">ç®¡ç†å‘˜</text>
              <view class="admin-grid">
                <input
                  class="form-input"
                  placeholder="å§“å"
                  value="{{form.adminInfo.name}}"
                  data-group="adminInfo"
                  data-field="name"
                  bindinput="onFormInput"
                />
                <input
                  class="form-input"
                  placeholder="èŒä½"
                  value="{{form.adminInfo.title}}"
                  data-group="adminInfo"
                  data-field="title"
                  bindinput="onFormInput"
                />
                <input
                  class="form-input"
                  placeholder="è”ç³»ç”µè¯"
                  value="{{form.adminInfo.phone}}"
                  data-group="adminInfo"
                  data-field="phone"
                  bindinput="onFormInput"
                />
              </view>
            </view>
          </view>
        </block>

        <block wx:elif="{{createStep === 1}}">
          <view class="form-section">
            <view class="section-title required">
              <text class="required-indicator">*</text>
              <text>å±•ç¤ºç´ æ</text>
            </view>
            <view class="media-grid">
              <block wx:for="{{form.images}}" wx:key="fileName">
                <view class="media-item">
                  <image class="media-image" src="{{item.url}}" mode="aspectFill" />
                  <view
                    class="media-remove"
                    data-type="images"
                    data-index="{{index}}"
                    bindtap="onRemoveMediaTap"
                  >âœ•</view>
                </view>
              </block>
              <view class="media-add" data-type="images" bindtap="onAddMediaTap">
                <text class="media-add-icon">ï¼‹</text>
                <text class="media-add-text">ä¸Šä¼ å›¾ç‰‡</text>
              </view>
            </view>
            <text class="helper-text">å»ºè®®ä¸Šä¼ é—¨åº—ã€åœºåœ°å®æ™¯å›¾ï¼Œæœ€å¤š9å¼ ã€‚</text>
          </view>

          <view class="form-section">
            <view class="section-title required">
              <text class="required-indicator">*</text>
              <text>è¥ä¸šæ‰§ç…§</text>
            </view>
            <view class="media-grid">
              <block wx:if="{{form.businessLicense}}">
                <view class="media-item">
                  <image class="media-image" src="{{form.businessLicense.url}}" mode="aspectFill" />
                  <view class="media-remove" data-type="businessLicense" bindtap="onRemoveMediaTap">âœ•</view>
                </view>
              </block>
              <view
                class="media-add"
                data-type="businessLicense"
                bindtap="onAddMediaTap"
                wx:if="{{!form.businessLicense}}"
              >
                <text class="media-add-icon">ï¼‹</text>
                <text class="media-add-text">ä¸Šä¼ æ‰§ç…§</text>
              </view>
            </view>
            <text class="helper-text">éœ€ä¸Šä¼ æ¸…æ™°å®Œæ•´çš„è¥ä¸šæ‰§ç…§ç…§ç‰‡ã€‚</text>
          </view>

          <view class="form-section">
            <text class="section-title">é™„ä»¶ææ–™</text>
            <view class="attachment-list">
              <block wx:for="{{form.attachmentFiles}}" wx:key="fileName">
                <view class="attachment-item">
                  <text class="attachment-icon">ğŸ“</text>
                  <text class="attachment-name">{{item.label || item.fileName}}</text>
                  <view
                    class="attachment-remove"
                    data-type="attachments"
                    data-index="{{index}}"
                    bindtap="onRemoveMediaTap"
                  >åˆ é™¤</view>
                </view>
              </block>
              <view class="attachment-add" data-type="attachments" bindtap="onAddMediaTap">
                ä¸Šä¼ é™„ä»¶
              </view>
            </view>
          </view>

          <view class="form-section">
            <text class="section-title">äºŒç»´ç </text>
            <view class="media-grid">
              <block wx:for="{{form.qrCodeImages}}" wx:key="fileName">
                <view class="media-item">
                  <image class="media-image" src="{{item.url}}" mode="aspectFill" />
                  <view
                    class="media-remove"
                    data-type="qrCodeImages"
                    data-index="{{index}}"
                    bindtap="onRemoveMediaTap"
                  >âœ•</view>
                </view>
              </block>
              <view class="media-add" data-type="qrCodeImages" bindtap="onAddMediaTap">
                <text class="media-add-icon">ï¼‹</text>
                <text class="media-add-text">ä¸Šä¼ äºŒç»´ç </text>
              </view>
            </view>
          </view>

          <view class="form-section">
            <text class="section-title">è§†é¢‘å·é“¾æ¥</text>
            <view class="tag-editor">
              <block wx:for="{{form.videoChannelUrls}}" wx:key="*this">
                <view class="tag-chip">
                  <text>{{item}}</text>
                  <view class="tag-remove" data-index="{{index}}" bindtap="onRemoveVideoUrl">âœ•</view>
                </view>
              </block>
              <input
                class="tag-input"
                placeholder="è¾“å…¥è§†é¢‘å·é“¾æ¥"
                value="{{videoInput}}"
                bindinput="onVideoInput"
                confirm-type="done"
                bindconfirm="onAddVideoUrl"
              />
              <view class="tag-add" bindtap="onAddVideoUrl">æ·»åŠ </view>
            </view>
          </view>
        </block>

        <block wx:elif="{{createStep === 2}}">
          <view class="form-section">
            <text class="section-title">é€‰æ‹©å¥—é¤</text>
            <view class="plan-list">
              <block wx:for="{{paymentPlans}}" wx:key="id">
                <view
                  class="plan-card {{selectedPlanId === item.id ? 'is-selected' : ''}}"
                  data-id="{{item.id}}"
                  bindtap="onPlanSelect"
                >
                  <view class="plan-header">
                    <text class="plan-name">{{item.name}}</text>
                    <text class="plan-price">Â¥{{item.price}}</text>
                  </view>
                  <text class="plan-desc">{{item.description}}</text>
                  <text class="plan-status">{{selectedPlanId === item.id ? 'å·²é€‰æ‹©' : 'ç‚¹å‡»é€‰æ‹©'}}</text>
                </view>
              </block>
            </view>
          </view>

          <view class="form-section">
            <text class="section-title">æäº¤ç¡®è®¤</text>
            <view class="summary-card">
              <text class="summary-item">æ ‡è®°åç§°ï¼š{{form.name}}</text>
              <text class="summary-item">è”ç³»ç”µè¯ï¼š{{form.phone}}</text>
              <text class="summary-item">æ ‡è®°ä½ç½®ï¼š{{form.locationText}}</text>
              <text class="summary-item">å¥—é¤è´¹ç”¨ï¼šÂ¥{{selectedPlan ? selectedPlan.price : '--'}}</text>
            </view>
            <text class="helper-text">æäº¤åå¹³å°å°†åœ¨ä¸¤ä¸ªå·¥ä½œæ—¥å†…å®Œæˆèµ„æ–™å®¡æ ¸å¹¶åé¦ˆç»“æœã€‚</text>
            <block wx:if="{{creationError}}">
              <view class="error-box">{{creationError}}</view>
            </block>
          </view>
        </block>

        <block wx:elif="{{createStep === 3}}">
          <view class="result-card" wx:if="{{creationResult && creationResult.status === 'success'}}">
            <view class="result-icon success">âœ“</view>
            <text class="result-title">æäº¤æˆåŠŸ</text>
            <text class="result-desc">{{creationResult.message}}</text>
            <view class="result-info">
              <text>æ ‡è®°åç§°ï¼š{{creationResult.marker.name}}</text>
              <text>å®¡æ ¸çŠ¶æ€ï¼š{{creationResult.marker.reviewStatusLabel}}</text>
            </view>
            <button class="result-btn" bindtap="onCloseCreate">å®Œæˆ</button>
          </view>
          <view class="result-card error" wx:elif="{{creationError}}">
            <view class="result-icon error">!</view>
            <text class="result-title">æäº¤å¤±è´¥</text>
            <text class="result-desc">{{creationError}}</text>
            <button class="result-btn" bindtap="goToPrevStep">è¿”å›ä¿®æ”¹</button>
          </view>
        </block>
      </scroll-view>

      <view class="drawer-footer" wx:if="{{createStep < 3}}">
        <button class="footer-btn secondary" wx:if="{{createStep > 0}}" bindtap="goToPrevStep">ä¸Šä¸€æ­¥</button>
        <block wx:if="{{createStep === 2}}">
          <button
            class="footer-btn primary"
            bindtap="submitMarker"
            loading="{{creationSubmitting}}"
            disabled="{{creationSubmitting}}"
          >
            æäº¤å®¡æ ¸
          </button>
        </block>
        <block wx:else>
          <button class="footer-btn primary" bindtap="goToNextStep">ä¸‹ä¸€æ­¥</button>
        </block>
      </view>
    </view>
  </view>
</view>
