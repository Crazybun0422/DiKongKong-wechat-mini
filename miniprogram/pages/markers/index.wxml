<view class="markers-page">
  <view wx:if="{{!showCreate && !showDetail}}" class="markers-shell">
    <view class="markers-static">
      <view class="page-header">
        <button class="create-btn" bindtap="onCreateTap">
          <image class="create-btn-icon" src="{{assetPaths.add}}" mode="aspectFit" />
          <text class="create-btn-text">æ–°å¢</text>
        </button>
      </view>

      <view class="status-tabs">
        <block wx:for="{{statusTabs}}" wx:key="id">
          <view
            class="status-tab {{filterStatus === item.id ? 'is-active' : ''}}"
            data-status="{{item.id}}"
            bindtap="onStatusTabTap"
          >
            <text>{{item.label}}</text>
          </view>
        </block>
      </view>
    </view>

    <scroll-view
      scroll-y
      class="markers-scroll"
      refresher-enabled="{{true}}"
      refresher-triggered="{{listRefreshing}}"
      bindrefresherrefresh="onPullDownRefresh"
    >
      <block wx:if="{{loading && !hasLoaded}}">
        <view class="state-card">åŠ è½½ä¸­...</view>
      </block>
      <block wx:elif="{{error}}">
        <view class="state-card state-error">
          <text class="state-text">{{error}}</text>
          <button class="retry-btn" bindtap="onRetryTap">é‡æ–°åŠ è½½</button>
        </view>
      </block>
      <block wx:elif="{{!visibleMarkers.length}}">
        <view class="empty-card">
          <view class="empty-icon-wrapper">
            <image class="empty-icon" src="/assets/drone2.png" mode="aspectFit" />
          </view>
          <text class="empty-title">æš‚æœªåˆ›å»ºæ ‡è®°</text>
          <text class="empty-desc">åœ¨ç©ºåŸŸå›¾è·å¾—å±•ç¤ºå¹¶ä½œä¸ºå¯ä¿¡èµ„æ–™è¢«å¹³å°AIé¦–é€‰å¼•ç”¨ã€‚
ä¹Ÿå°†ä½œä¸ºç©ºåŸŸæ’ä»¶ï¼ˆMCPï¼‰è‡ªå¸¦æ•°æ®ï¼Œé€šè¿‡å¼€æ”¾å¹³å°è·å¾—ç«™å¤–æ›å…‰å’Œè±†åŒ…ã€å…ƒå®ç­‰å¼•ç”¨ã€‚</text>
          <button class="empty-action" bindtap="onCreateTap">ç«‹å³åˆ›å»º</button>
        </view>
      </block>
      <block wx:else>
        <view class="marker-list">
          <block wx:for="{{visibleMarkers}}" wx:key="id">
            <view class="marker-card" bindtap="onMarkerCardTap" data-id="{{item.id}}">
              <view class="status-corner {{item.reviewTone}}">
                <text class="status-corner-text">{{item.reviewStatusLabel}}</text>
              </view>
              <view class="card-body">
                <view class="card-top">
                  <view class="card-info">
                    <text class="marker-name">{{item.name || 'æœªå‘½åæ ‡è®°'}}</text>
                    <text class="marker-location">{{item.locationText || 'æœªå¡«å†™ä½ç½®'}}</text>
                    <text class="marker-created">{{item.timelineLabel}}: {{item.timelineDisplay}}</text>
                    <view class="card-stats">
                      <view class="stat-item">
                        <image class="stat-icon" src="{{assetPaths.exposure}}" mode="aspectFit" />
                        <text class="stat-value">{{item.exposureCount}}</text>
                      </view>
                      <view class="stat-item">
                        <image class="stat-icon" src="{{assetPaths.telephone}}" mode="aspectFit" />
                        <text class="stat-value">{{item.phoneCallCount}}</text>
                      </view>
                    </view>
                  </view>
                  <image
                    class="marker-cover"
                    src="{{item.coverImage || defaultCoverImage}}"
                    mode="aspectFill"
                  />
                </view>
              </view>
            </view>
          </block>
        </view>
      </block>
    </scroll-view>
  </view>

  <view wx:if="{{showDetail}}" class="drawer-overlay">
    <view class="drawer">
      <view class="drawer-header">
        <text class="drawer-title">æ ‡è®°è¯¦æƒ…</text>
        <view class="drawer-close" bindtap="onCloseDetail">âœ•</view>
      </view>
      <scroll-view scroll-y class="drawer-body">
        <view class="detail-section">
          <text class="detail-title">åŸºç¡€ä¿¡æ¯</text>
          <view class="detail-item">
            <text class="detail-label">æ ‡è®°åç§°</text>
            <text class="detail-value">{{activeMarker.name}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å®¡æ ¸çŠ¶æ€</text>
            <text class="detail-value status-text {{activeMarker.reviewTone}}">{{activeMarker.reviewStatusLabel}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ”¯ä»˜çŠ¶æ€</text>
            <text class="detail-value">{{activeMarker.paidLabel}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ä½ç½®</text>
            <text class="detail-value">{{activeMarker.locationText || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">è”ç³»ç”µè¯</text>
            <text class="detail-value">{{activeMarker.phone || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ç®€ä»‹</text>
            <text class="detail-value">{{activeMarker.description || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">åˆ›å»ºæ—¶é—´</text>
            <text class="detail-value">{{activeMarker.createdAtDisplay}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ›´æ–°æ—¶é—´</text>
            <text class="detail-value">{{activeMarker.updatedAtDisplay}}</text>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.industryHonorTags && activeMarker.industryHonorTags.length}}">
          <text class="detail-title">è¡Œä¸šè£èª‰</text>
          <view class="tag-display">
            <block wx:for="{{activeMarker.industryHonorTags}}" wx:key="*this">
              <view class="tag-chip">{{item}}</view>
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.images && activeMarker.images.length}}">
          <text class="detail-title">å±•ç¤ºå›¾</text>
          <view class="media-preview-grid">
            <block wx:for="{{activeMarker.images}}" wx:key="id">
              <image class="media-preview" src="{{item.url}}" mode="aspectFill" />
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.businessLicense}}">
          <text class="detail-title">è¥ä¸šæ‰§ç…§</text>
          <image class="license-preview" src="{{activeMarker.businessLicense.url}}" mode="aspectFill" />
        </view>

        <view class="detail-section" wx:if="{{activeMarker.attachments && activeMarker.attachments.length}}">
          <text class="detail-title">é™„ä»¶</text>
          <view class="attachment-list">
            <block wx:for="{{activeMarker.attachments}}" wx:key="id">
              <view class="attachment-item">
                <text class="attachment-icon">ğŸ“</text>
                <text class="attachment-name">{{item.label || 'ä¼ä¸šäº§å“å’Œä¸šåŠ¡ä»‹ç»'}}</text>
              </view>
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.qrCodes && activeMarker.qrCodes.length}}">
          <text class="detail-title">äºŒç»´ç </text>
          <view class="qr-code-list">
            <block wx:for="{{activeMarker.qrCodes}}" wx:key="id">
              <image class="qr-code-preview" src="{{item.url}}" mode="widthFix" show-menu-by-longpress />
            </block>
          </view>
        </view>

        <view class="detail-section" wx:if="{{activeMarker.videoChannelUrls && activeMarker.videoChannelUrls.length}}">
          <text class="detail-title">è§†é¢‘å·é“¾æ¥</text>
          <view class="detail-list">
            <block wx:for="{{activeMarker.videoChannelUrls}}" wx:key="*this">
              <text class="detail-link">{{item}}</text>
            </block>
          </view>
        </view>

        <view
          class="detail-section"
          wx:if="{{activeMarker.adminInfo &&(activeMarker.adminInfo.name || activeMarker.adminInfo.phone || activeMarker.adminInfo.title)}}"
        >
          <text class="detail-title">ç®¡ç†å‘˜è”ç³»</text>
          <view class="detail-item">
            <text class="detail-label">å§“å</text>
            <text class="detail-value">{{activeMarker.adminInfo.name || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">èŒä½</text>
            <text class="detail-value">{{activeMarker.adminInfo.title || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ç”µè¯</text>
            <text class="detail-value">{{activeMarker.adminInfo.phone || 'æœªå¡«å†™'}}</text>
          </view>
        </view>

        <!-- <button
          class="danger-btn"
          data-id="{{activeMarker.id}}"
          bindtap="onDeleteMarkerTap"
          loading="{{deletingId === activeMarker.id}}"
          disabled="{{deletingId === activeMarker.id}}"
        >
          åˆ é™¤æ ‡è®°
        </button> -->
      </scroll-view>
    </view>
  </view>

  <view wx:if="{{showCreate}}" class="drawer-overlay">
    <view class="drawer">
      <view class="drawer-header">
        <text class="drawer-title">åˆ›å»ºåœ°å›¾æ ‡è®°</text>
        <view class="drawer-close" bindtap="onCloseCreate">âœ•</view>
      </view>
      <view class="drawer-step-indicator">
        <view class="step-indicator">
          <block wx:for="{{createSteps}}" wx:key="label">
            <view class="step-item-wrapper">
              <view
                class="step-item {{createStep === index ? 'is-current' : (createStep > index ? 'is-finished' : '')}} {{resultStepsLocked && index < 3 ? 'is-disabled' : ''}}"
                data-step="{{index}}"
                bindtap="onStepIndicatorTap"
              >
                <view class="step-circle {{createStep === index ? 'is-active' : (createStep > index ? 'is-finished' : '')}}">
                  <text>{{index + 1}}</text>
                </view>
                <text class="step-label">{{item.label}}</text>
              </view>
              <view
                wx:if="{{index < createSteps.length - 1}}"
                class="step-connector {{createStep > index ? 'is-active' : ''}}"
              ></view>
            </view>
          </block>
        </view>
      </view>

      <scroll-view scroll-y class="drawer-body">
        <block wx:if="{{createStep === 0}}">
          <view class="form-card">
            <view class="field-row">
              <view class="field-label required">
                <text class="required-star">*</text>
                <text>å›¾ç‰‡</text>
              </view>
              <view class="image-uploader">
                <block wx:for="{{form.images}}" wx:key="fileName">
                  <view class="image-thumb">
                    <image class="image-thumb-img" src="{{item.url}}" mode="aspectFill" />
                    <view
                      class="image-remove"
                      data-type="images"
                      data-index="{{index}}"
                      bindtap="onRemoveMediaTap"
                    >âœ•</view>
                  </view>
                </block>
                <view class="image-add" data-type="images" bindtap="onAddMediaTap">
                  <image class="image-add-icon" src="{{assetPaths.add}}" mode="aspectFit" />
                  <text class="image-add-text">ä¸Šä¼ </text>
                </view>
              </view>
            </view>

            <view class="field-row">
              <view class="field-label required">
                <text class="required-star">*</text>
                <text>åç§°</text>
              </view>
              <input
                class="field-input form-input"
                placeholder="è¯·è¾“å…¥"
                value="{{form.name}}"
                data-field="name"
                bindinput="onFormInput"
              />
            </view>

            <view class="field-row">
              <view class="field-label required">
                <text class="required-star">*</text>
                <text>ç®€ä»‹</text>
              </view>
              <textarea
                class="field-textarea form-textarea"
                placeholder="è¯·è¾“å…¥"
                value="{{form.description}}"
                data-field="description"
                bindinput="onFormInput"
                maxlength="500"
                auto-height
              />
            </view>

            <view class="field-row">
              <view class="field-label required">
                <text class="required-star">*</text>
                <text>ä½ç½®</text>
              </view>
              <view class="location-box location-selector" bindtap="onChooseLocation">
                <text class="location-text">{{form.locationText || 'ç‚¹å‡»é€‰æ‹©'}}</text>
              </view>
            </view>

            <view class="field-row">
              <view class="field-label required">
                <text class="required-star">*</text>
                <text>ç”µè¯</text>
              </view>
              <input
                class="field-input form-input"
                placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
                value="{{form.phone}}"
                data-field="phone"
                bindinput="onFormInput"
              />
            </view>
          </view>
        </block>

        <block wx:elif="{{createStep === 1}}">
          <view class="form-card">
            <view class="field-label required">
              <text class="required-star">*</text>
              <text>è¥ä¸šæ‰§ç…§</text>
            </view>
            <view class="media-grid">
              <block wx:if="{{form.businessLicense}}">
                <view class="media-item">
                  <image class="media-image" src="{{form.businessLicense.url}}" mode="aspectFill" />
                  <view class="media-remove" data-type="businessLicense" bindtap="onRemoveMediaTap">âœ•</view>
                </view>
              </block>
              <view
                class="media-add"
                data-type="businessLicense"
                bindtap="onAddMediaTap"
                wx:if="{{!form.businessLicense}}"
              >
                <text class="media-add-icon">ï¼‹</text>
                <text class="media-add-text">ä¸Šä¼ æ‰§ç…§</text>
              </view>
            </view>
          </view>

          <view class="form-card">
            <view class="field-label">è¡Œä¸šè£èª‰æ ‡ç­¾</view>
            <view class="field-tip">å¦‚é«˜æ–°æŠ€æœ¯ä¼ä¸šã€/åŸ¹è®­èµ„è´¨/è¡Œä¸šå…³é”®è¯</view>
            <view class="tag-editor">
              <block wx:for="{{form.industryHonorTags}}" wx:key="*this">
                <view class="tag-chip">
                  <text>{{item}}</text>
                  <view class="tag-remove" data-index="{{index}}" bindtap="onRemoveTag">âœ•</view>
                </view>
              </block>
              <input
                class="tag-input"
                placeholder="è¾“å…¥åå›è½¦æ·»åŠ "
                value="{{tagInput}}"
                confirm-type="done"
                bindinput="onTagInput"
                bindconfirm="onTagConfirm"
              />
            </view>
          </view>

          <view class="form-card">
            <view class="field-label">é™„ä»¶ä¸Šä¼ </view>
            <view class="field-tip">è¯·å…ˆå°†æ–‡ä»¶å‘é€åˆ°å¾®ä¿¡æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹å¯¹è¯æ¡†ï¼Œå†ç‚¹å‡»"ä¸Šä¼ é™„ä»¶"ã€‚</view>
            <view class="attachment-list">
              <block wx:for="{{form.attachmentFiles}}" wx:key="fileName">
                <view class="attachment-item">
                  <text class="attachment-icon">ğŸ“</text>
                  <text class="attachment-name">{{item.label || 'ä¼ä¸šäº§å“å’Œä¸šåŠ¡ä»‹ç»'}}</text>
                  <view
                    class="attachment-remove"
                    data-type="attachments"
                    data-index="{{index}}"
                    bindtap="onRemoveMediaTap"
                  >åˆ é™¤</view>
                </view>
              </block>
              <view
                wx:if="{{form.attachmentFiles.length < 1}}"
                class="attachment-add"
                data-type="attachments"
                bindtap="onAddMediaTap"
              >ä¸Šä¼ é™„ä»¶</view>
            </view>
          </view>

          <view class="form-card">
            <view class="field-label">äºŒç»´ç </view>
            <view class="media-grid">
              <block wx:for="{{form.qrCodeImages}}" wx:key="fileName">
                <view class="media-item">
                  <image class="media-image" src="{{item.url}}" mode="aspectFill" />
                  <view
                    class="media-remove"
                    data-type="qrCodeImages"
                    data-index="{{index}}"
                    bindtap="onRemoveMediaTap"
                  >âœ•</view>
                </view>
              </block>
              <view
                wx:if="{{form.qrCodeImages.length < qrCodeMaxCount}}"
                class="media-add"
                data-type="qrCodeImages"
                bindtap="onAddMediaTap"
              >
                <text class="media-add-icon">ï¼‹</text>
                <text class="media-add-text">ä¸Šä¼ äºŒç»´ç </text>
              </view>
            </view>
          </view>

          <view class="form-card">
            <view class="field-label">æŒ‚è½½è§†é¢‘å·è§†é¢‘</view>
            <view class="video-form">
              <view class="video-field">
                <text class="video-field-label">è§†é¢‘å·ID</text>
                <input
                  class="field-input form-input"
                  placeholder="è¯·è¾“å…¥"
                  value="{{form.videoChannelId}}"
                  data-field="videoChannelId"
                  bindinput="onFormInput"
                />
              </view>
              <view class="video-field">
                <text class="video-field-label">è§†é¢‘ID</text>
                <input
                  class="field-input form-input"
                  placeholder="è¯·è¾“å…¥"
                  value="{{form.videoId}}"
                  data-field="videoId"
                  bindinput="onFormInput"
                />
              </view>
            </view>
          </view>
        </block>

        <block wx:elif="{{createStep === 2}}">
          <view class="form-card">
            <view class="field-label required">
              <text class="required-star">*</text>
              <text>ç®¡ç†å‘˜ä¿¡æ¯</text>
            </view>
            <text class="field-tip">ä¸å¯¹å¤–å±•ç¤ºï¼Œä»…ç”¨äºå®¡æ ¸ç­‰é‡è¦é€šçŸ¥</text>
            <view class="admin-grid">
              <input
                class="field-input form-input"
                placeholder="å§“å"
                value="{{form.adminInfo.name}}"
                data-group="adminInfo"
                data-field="name"
                bindinput="onFormInput"
              />
              <input
                class="field-input form-input"
                placeholder="èŒä½"
                value="{{form.adminInfo.title}}"
                data-group="adminInfo"
                data-field="title"
                bindinput="onFormInput"
              />
              <input
                class="field-input form-input"
                placeholder="è”ç³»ç”µè¯"
                value="{{form.adminInfo.phone}}"
                data-group="adminInfo"
                data-field="phone"
                bindinput="onFormInput"
              />
            </view>
          </view>

          <view class="form-card" wx:if="{{showPaymentSection}}">
            <view class="field-label required">
              <text class="required-star">*</text>
              <text>æ”¯ä»˜è®¤è¯è´¹</text>
            </view>
            <view class="payment-options">
              <block wx:for="{{paymentMethods}}" wx:key="id">
                <view
                  class="payment-option {{selectedPaymentMethod === item.id ? 'is-active' : ''}} {{item.id === 'FLP' && flpPaymentDisabled ? 'is-disabled' : ''}}"
                  data-method="{{item.id}}"
                  bindtap="onSelectPaymentMethod"
                >
                  <view class="payment-option-header">
                    <text class="payment-option-title">{{item.label}}</text>
                    <text class="payment-option-note" wx:if="{{item.id === 'FLP'}}">{{flpPaymentNote}}</text>
                    <text class="payment-option-note" wx:elif="{{item.note}}">{{item.note}}</text>
                  </view>
                  <view class="payment-price" wx:if="{{item.id === 'WECHAT'}}">
                    <text class="price-tag">{{wechatPriceDisplay || 'Â¥--'}}</text>
                    <text class="price-original" wx:if="{{wechatListPriceDisplay}}">{{wechatListPriceDisplay}}</text>
                  </view>
                  <view class="payment-price" wx:elif="{{item.id === 'FLP'}}">
                    <text class="price-tag">{{flpPriceDisplay || 'FLP--'}}</text>
                    <text class="price-original" wx:if="{{flpListPriceDisplay}}">{{flpListPriceDisplay}}</text>
                  </view>
                </view>
              </block>
            </view>
            <!-- <view class="payment-summary">
              <text class="payment-summary-item" wx:if="{{wechatPriceDisplay}}">{{wechatPriceDisplay}}</text>
              <text class="payment-summary-item" wx:if="{{flpPriceDisplay}}">{{flpPriceDisplay}}</text>
            </view> -->
          </view>

          <view class="form-card" wx:if="{{!showPaymentSection}}">
            <view class="field-label">
              <text>æ”¯ä»˜è®¤è¯è´¹</text>
            </view>
            <text class="field-tip">å½“å‰æ ‡è®°å·²å®Œæˆæ”¯ä»˜ï¼Œæ— éœ€å†æ¬¡é€‰æ‹©æ”¯ä»˜æ–¹å¼ã€‚</text>
          </view>

          <block wx:if="{{creationError}}">
            <view class="error-box">{{creationError}}</view>
          </block>
        </block>

        <block wx:elif="{{createStep === 3}}">
          <view class="result-card" wx:if="{{creationResult && creationResult.status === 'success'}}">
            <view class="result-icon success">âœ“</view>
            <text class="result-title">{{creationResult.title || 'æäº¤æˆåŠŸ'}}</text>
            <text class="result-desc">{{creationResult.message}}</text>
            <view class="result-info">
              <text>æ ‡è®°åç§°ï¼š{{creationResult.marker.name}}</text>
            </view>
            <button class="result-btn" bindtap="onCloseCreate">å®Œæˆ</button>
          </view>
          <view class="result-card error" wx:elif="{{creationError}}">
            <view class="result-icon error">!</view>
            <text class="result-title">æäº¤å¤±è´¥</text>
            <text class="result-desc">{{creationError}}</text>
            <button class="result-btn" bindtap="goToPrevStep">è¿”å›ä¿®æ”¹</button>
          </view>
        </block>
      </scroll-view>

      <view class="drawer-footer" wx:if="{{createStep < 3}}">
        <button class="footer-btn secondary" wx:if="{{createStep > 0}}" bindtap="goToPrevStep">ä¸Šä¸€æ­¥</button>
        <block wx:if="{{createStep === 2}}">
          <button
            class="footer-btn primary"
            bindtap="submitMarker"
            loading="{{creationSubmitting}}"
            disabled="{{creationSubmitting}}"
          >
            {{submitButtonText}}
          </button>
        </block>
        <block wx:else>
          <button class="footer-btn primary" bindtap="goToNextStep">ä¸‹ä¸€æ­¥</button>
        </block>
      </view>
    </view>
  </view>

  <view wx:if="{{actionSheetVisible}}" class="action-sheet-overlay" catchtouchmove="noop">
    <view class="action-sheet-mask" bindtap="onActionSheetCancel" catchtouchmove="noop"></view>
    <view class="action-sheet-container" catchtap="noop" catchtouchmove="noop">
      <view class="action-sheet-card">
        <view class="action-sheet-item" data-action="home" bindtap="onActionSheetAction">ä¸»é¡µé¢„è§ˆ</view>
        <view class="action-sheet-item" data-action="detail" bindtap="onActionSheetAction">è¯¦æƒ…</view>
        <view
          class="action-sheet-item {{actionSheetDisableModify ? 'action-sheet-item-disabled' : ''}}"
          data-action="edit"
          bindtap="onActionSheetAction"
        >
          ç¼–è¾‘
        </view>
        <view
          class="action-sheet-item action-sheet-item-danger {{actionSheetDisableModify ? 'action-sheet-item-disabled' : ''}}"
          data-action="delete"
          bindtap="onActionSheetAction"
        >
          åˆ é™¤
        </view>
      </view>
      <view class="action-sheet-card action-sheet-card-cancel">
        <view class="action-sheet-item action-sheet-item-cancel" data-action="cancel" bindtap="onActionSheetAction">
          å–æ¶ˆ
        </view>
      </view>
    </view>
  </view>
</view>
